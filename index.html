<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Pulse - ××¨×•×¥ ×”×›×¤×•×œ×•×ª</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Noto+Sans+Hebrew:wght@300;700;900&display=swap" rel="stylesheet">
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            background-color: #020617;
            font-family: 'Noto Sans Hebrew', 'Orbitron', sans-serif;
            color: white;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .grid-bg {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(34, 211, 238, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 211, 238, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            perspective: 1000px;
            transform: rotateX(60deg) translateY(-20%) scale(2);
            transform-origin: top;
            z-index: -5;
            opacity: 0.3;
            animation: grid-move 20s linear infinite;
        }
        @keyframes grid-move {
            0% { background-position: 0 0; }
            100% { background-position: 0 500px; }
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .neon-text {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.5), 0 0 20px rgba(34, 211, 238, 0.3);
        }
        .dir-rtl { direction: rtl; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Added data-type="module" to fix the 'require is not defined' error with Babel Standalone and Firebase ESM -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        const TABLES_LIST = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
        const DIFFICULTIES = {
            easy: { label: '×§×œ', tables: [2, 3, 4, 5], time: 90, color: 'text-green-400', border: 'border-green-500/30' },
            medium: { label: '×‘×™× ×•× ×™', tables: [2, 3, 4, 5, 6, 7, 8, 9, 10], time: 60, color: 'text-yellow-400', border: 'border-yellow-500/30' },
            hard: { label: '×§×©×”', tables: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], time: 45, color: 'text-red-400', border: 'border-red-500/30' },
            custom: { label: '××•×ª××', tables: [], time: 60, color: 'text-cyan-400', border: 'border-cyan-500/30' }
        };

        const App = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');
            
            const [role, setRole] = useState('student');
            const [screen, setScreen] = useState('welcome');
            const [playerName, setPlayerName] = useState('');
            const [difficulty, setDifficulty] = useState('medium');
            const [selectedTables, setSelectedTables] = useState([2, 3, 4, 5]);
            
            // Game State
            const [currentProblem, setCurrentProblem] = useState(null);
            const [options, setOptions] = useState([]);
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [isGameOver, setIsGameOver] = useState(false);
            const [feedback, setFeedback] = useState(null);
            
            // Multiplayer & History
            const [roomId, setRoomId] = useState('');
            const [roomData, setRoomData] = useState(null);
            const [gameMode, setGameMode] = useState('solo');
            const [history, setHistory] = useState([]);

            // 1. Initialize Firebase (Mandatory Rule 3)
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        // Dynamic imports inside a Babel module script
                        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js');
                        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js');
                        const { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, addDoc, getDoc, query } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');

                        // Safe extraction of environment variables
                        const config = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config;
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neon-pulse-final';

                        const api = { doc, setDoc, onSnapshot, updateDoc, collection, addDoc, getDoc, query };
                        setFb({ auth, db, appId, api });

                        // Rule 3: Auth BEFORE Queries
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setLoading(false);
                            }
                        });
                    } catch (e) {
                        console.error("Firebase Initialization Error:", e);
                        setErrorMessage('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. × ×¡×™ ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.');
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            // 2. Room Listener (Multiplayer)
            useEffect(() => {
                if (!fb || !user || !roomId || screen === 'welcome') return;
                
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                const unsub = fb.api.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setRoomData(data);
                        
                        if (data.status === 'playing' && screen === 'lobby') {
                            setGameMode('battle');
                            startGame(data.tables, data.time);
                        }
                    }
                }, (err) => {
                    console.error("Room listener error:", err);
                    if (err.code === 'permission-denied') {
                        setErrorMessage('×‘×¢×™×™×ª ×”×¨×©××•×ª ×‘×’×™×©×” ×œ×—×“×¨.');
                    }
                });
                
                return () => unsub();
            }, [fb, user, roomId, screen]);

            // 3. Teacher Dashboard Data
            useEffect(() => {
                if (!fb || !user || screen !== 'teacher-dashboard') return;
                const historyRef = fb.api.collection(fb.db, 'artifacts', fb.appId, 'public', 'data', 'history');
                const unsub = fb.api.onSnapshot(historyRef, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setHistory(data.sort((a, b) => b.timestamp - a.timestamp));
                });
                return () => unsub();
            }, [fb, user, screen]);

            // Game Logic Functions
            const generateProblem = (tables = selectedTables) => {
                const active = (tables && tables.length > 0) ? tables : [2, 3, 4, 5];
                const t1 = active[Math.floor(Math.random() * active.length)];
                const t2 = Math.floor(Math.random() * 11) + 2;
                const ans = t1 * t2;
                let opts = new Set([ans]);
                while (opts.size < 4) {
                    const w = (t1 + (Math.random() > 0.5 ? 1 : -1)) * (t2 + Math.floor(Math.random() * 3) - 1);
                    if (w > 0 && w !== ans) opts.add(w);
                    else opts.add(Math.floor(Math.random() * 100) + 1);
                }
                setCurrentProblem({ t1, t2, ans });
                setOptions(Array.from(opts).sort(() => Math.random() - 0.5));
            };

            const startGame = (tablesFromRoom, timeFromRoom) => {
                const finalTables = tablesFromRoom || (difficulty === 'custom' ? selectedTables : DIFFICULTIES[difficulty].tables);
                const finalTime = timeFromRoom || DIFFICULTIES[difficulty].time;
                
                setScore(0);
                setStreak(0);
                setTimeLeft(finalTime);
                setIsGameOver(false);
                setSelectedTables(finalTables);
                setScreen('game');
                generateProblem(finalTables);
            };

            useEffect(() => {
                if (screen === 'game' && timeLeft > 0 && !isGameOver) {
                    const timer = setTimeout(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && screen === 'game' && !isGameOver) {
                    finishGame();
                }
            }, [timeLeft, screen, isGameOver]);

            const handleAnswer = async (val) => {
                if (!currentProblem || !fb || !user) return;
                
                if (val === currentProblem.ans) {
                    const newScore = score + (10 * (streak + 1));
                    const newStreak = streak + 1;
                    setScore(newScore);
                    setStreak(newStreak);
                    setFeedback({ type: 'correct', val: '××“×”×™×!' });
                    
                    if (gameMode === 'battle' && roomId) {
                        const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                        try {
                            await fb.api.updateDoc(roomRef, {
                                [`players.${user.uid}.score`]: newScore,
                                [`players.${user.uid}.streak`]: newStreak
                            });
                        } catch (e) { console.error("Score update failed", e); }
                    }
                } else {
                    setStreak(0);
                    setFeedback({ type: 'wrong', val: `××•×¤×¡.. ×–×” ${currentProblem.ans}` });
                }
                setTimeout(() => { setFeedback(null); generateProblem(); }, 600);
            };

            const finishGame = async () => {
                setIsGameOver(true);
                setScreen('results');
                
                if (user && fb) {
                    try {
                        const historyRef = fb.api.collection(fb.db, 'artifacts', fb.appId, 'public', 'data', 'history');
                        await fb.api.addDoc(historyRef, {
                            name: playerName || '××•×¨×—×ª',
                            score,
                            difficulty: difficulty === 'custom' ? '××•×ª××' : DIFFICULTIES[difficulty].label,
                            timestamp: Date.now()
                        });
                        
                        if (gameMode === 'battle' && roomId) {
                            const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId);
                            await fb.api.updateDoc(roomRef, { [`players.${user.uid}.finished`]: true });
                        }
                    } catch (e) { console.error("Save history error", e); }
                }
            };

            // Room Management
            const createRoom = async () => {
                setErrorMessage('');
                if (!playerName.trim() || !user || !fb) {
                    setErrorMessage('×× × ×”×›× ×™×¡×™ ×©× ×œ×¤× ×™ ×™×¦×™×¨×ª ×—×“×¨, ××• ×”××ª×™× ×™ ×œ×—×™×‘×•×¨ ×”××¢×¨×›×ª.');
                    return;
                }
                
                const rid = Math.random().toString(36).substring(2, 7).toUpperCase();
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', rid);
                
                const roomSettings = {
                    id: rid,
                    host: user.uid,
                    status: 'waiting',
                    tables: difficulty === 'custom' ? selectedTables : DIFFICULTIES[difficulty].tables,
                    time: difficulty === 'custom' ? 60 : DIFFICULTIES[difficulty].time,
                    players: { 
                        [user.uid]: { name: playerName, score: 0, streak: 0, finished: false } 
                    },
                    createdAt: Date.now()
                };
                
                try {
                    await fb.api.setDoc(roomRef, roomSettings);
                    setRoomId(rid);
                    setGameMode('battle');
                    setScreen('lobby');
                } catch (e) {
                    console.error("Create Room Error:", e);
                    setErrorMessage('× ×›×©×œ ×‘×™×¦×™×¨×ª ×—×“×¨. ×‘×“×§×™ ×—×™×‘×•×¨.');
                }
            };

            const joinRoom = async () => {
                setErrorMessage('');
                if (!playerName.trim() || !roomId.trim()) {
                    setErrorMessage('×—×¡×¨ ×©× ××• ×§×•×“ ×—×“×¨');
                    return;
                }
                if (!user || !fb) return;
                
                const rid = roomId.trim().toUpperCase();
                const roomRef = fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', rid);
                
                try {
                    const snap = await fb.api.getDoc(roomRef);
                    if (snap.exists()) {
                        await fb.api.updateDoc(roomRef, {
                            [`players.${user.uid}`]: { name: playerName, score: 0, streak: 0, finished: false }
                        });
                        setRoomId(rid);
                        setGameMode('battle');
                        setScreen('lobby');
                    } else {
                        setErrorMessage('×”×—×“×¨ ×œ× × ××¦×. ×‘×“×§×™ ××ª ×”×§×•×“ ×©×•×‘.');
                    }
                } catch (e) {
                    console.error("Join Room Error:", e);
                    setErrorMessage('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×—×“×¨.');
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-cyan-400 font-bold animate-pulse uppercase tracking-widest text-xs italic">System Initializing...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center">
                    <div className="grid-bg"></div>
                    
                    <header className="w-full p-6 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/5 sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-cyan-500 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(6,182,212,0.5)]">
                                <span className="font-black text-white italic">N</span>
                            </div>
                            <h1 className="text-xl font-black tracking-tighter bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text text-transparent uppercase italic">Neon Pulse</h1>
                        </div>
                        <div className="flex gap-2">
                            {screen !== 'welcome' && <button onClick={() => { setScreen('welcome'); setErrorMessage(''); }} className="p-2 glass rounded-lg hover:bg-white/10 transition px-4 font-bold text-xs">Home</button>}
                            {role === 'teacher' && screen === 'welcome' && <button onClick={() => setScreen('teacher-dashboard')} className="bg-fuchsia-600 px-4 py-1 rounded-lg text-xs font-bold shadow-lg shadow-fuchsia-900/40">×œ×•×— ××•×¨×”</button>}
                        </div>
                    </header>

                    <main className="flex-1 w-full max-w-2xl p-6 flex flex-col items-center justify-center">
                        
                        {errorMessage && (
                            <div className="w-full mb-6 p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-200 text-center font-bold text-sm">
                                {errorMessage}
                            </div>
                        )}

                        {screen === 'welcome' && (
                            <div className="w-full space-y-10 text-center animate-in fade-in slide-in-from-bottom-4">
                                <div className="space-y-2">
                                    <h2 className="text-5xl font-black leading-tight italic uppercase">××¨×•×¥ <span className="text-cyan-400 neon-text">×”×›×¤×•×œ×•×ª</span></h2>
                                    <p className="text-gray-500 font-bold uppercase tracking-widest text-[10px]">Neon Multi Player Experience</p>
                                </div>

                                <div className="glass p-8 rounded-[2.5rem] space-y-8 shadow-2xl">
                                    <div className="flex bg-black/40 p-1 rounded-xl">
                                        <button onClick={() => setRole('student')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition ${role === 'student' ? 'bg-cyan-600 text-white' : 'text-gray-500'}`}>×ª×œ××™×“×”</button>
                                        <button onClick={() => setRole('teacher')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition ${role === 'teacher' ? 'bg-fuchsia-600 text-white' : 'text-gray-500'}`}>××•×¨×”</button>
                                    </div>
                                    <input type="text" placeholder="××” ×©××š?" className="w-full bg-black/50 border-2 border-white/5 rounded-2xl px-6 py-4 text-xl focus:border-cyan-500 outline-none text-center font-bold" value={playerName} onChange={e => setPlayerName(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => { if(!playerName) return; setGameMode('solo'); setScreen('difficulty'); }} className="flex flex-col items-center gap-3 p-6 bg-white/5 hover:bg-cyan-500/10 rounded-3xl border border-white/5 transition active:scale-95 disabled:opacity-20" disabled={!playerName}>
                                            <span className="text-cyan-400 text-2xl font-black italic">SOLO</span>
                                            <span className="text-[10px] font-bold uppercase">××©×—×§ ×™×—×™×“</span>
                                        </button>
                                        <button onClick={() => { if(!playerName) return; setScreen('multi-choice'); }} className="flex flex-col items-center gap-3 p-6 bg-white/5 hover:bg-fuchsia-500/10 rounded-3xl border border-white/5 transition active:scale-95 disabled:opacity-20" disabled={!playerName}>
                                            <span className="text-fuchsia-400 text-2xl font-black italic">BATTLE</span>
                                            <span className="text-[10px] font-bold uppercase">×ª×—×¨×•×ª ×—×‘×¨×•×ª</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {screen === 'difficulty' && (
                            <div className="w-full space-y-6 animate-in slide-in-from-bottom-6">
                                <h2 className="text-3xl font-black text-center italic">×‘×—×¨×™ ×¨××”</h2>
                                {Object.entries(DIFFICULTIES).map(([k, d]) => (
                                    <button key={k} onClick={() => { setDifficulty(k); if(k==='custom') setScreen('solo-config'); else startGame(); }} className={`w-full flex items-center justify-between p-8 glass rounded-3xl hover:bg-white/5 transition active:scale-95 border-l-4 ${d.color.replace('text', 'border')} border-l-8`}>
                                        <div className="text-right">
                                            <div className="text-2xl font-black">{d.label}</div>
                                            <div className="text-xs text-gray-500 font-bold">{k==='custom'?'×‘×—×™×¨×” ×™×“× ×™×ª':`×œ×•×—×•×ª: ${d.tables.join(', ')}`}</div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-black/40 px-3 py-1 rounded-lg border border-white/5">
                                            <span className="font-black text-xs tabular-nums">{d.time}s</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        {screen === 'game' && currentProblem && (
                            <div className="w-full flex flex-col gap-8 animate-in zoom-in">
                                <div className="flex justify-between items-center glass p-6 rounded-[2.5rem] shadow-xl">
                                    <div className="text-center">
                                        <div className="text-[10px] text-cyan-400 font-black uppercase tracking-widest">Score</div>
                                        <div className="text-4xl font-black tabular-nums">{score}</div>
                                    </div>
                                    <div className={`w-20 h-20 rounded-full border-[5px] flex items-center justify-center transition-all ${timeLeft < 10 ? 'border-red-500 text-red-500 animate-pulse' : 'border-white/10'}`}>
                                        <span className="text-4xl font-black tabular-nums">{timeLeft}</span>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-[10px] text-fuchsia-400 font-black uppercase tracking-widest">Streak</div>
                                        <div className="text-4xl font-black tabular-nums">{streak}</div>
                                    </div>
                                </div>

                                <div className="relative glass p-16 rounded-[3.5rem] flex flex-col items-center gap-4 shadow-2xl">
                                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-1/2 h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent"></div>
                                    <div className="text-8xl font-black flex items-center gap-6 italic tracking-tighter tabular-nums">
                                        <span>{currentProblem.t1}</span>
                                        <span className="text-cyan-400 text-6xl">Ã—</span>
                                        <span>{currentProblem.t2}</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 w-full">
                                    {options.map((o, i) => (
                                        <button key={i} onClick={() => handleAnswer(o)} className="glass py-10 rounded-[2rem] text-5xl font-black hover:bg-white/5 hover:border-cyan-400/50 transition active:scale-90 shadow-xl tabular-nums">{o}</button>
                                    ))}
                                </div>

                                {gameMode === 'battle' && roomData && (
                                    <div className="w-full bg-white/5 p-4 rounded-3xl border border-white/5 space-y-3 shadow-inner">
                                        <p className="text-[10px] text-gray-500 font-black tracking-widest text-center uppercase italic">Live Ranking</p>
                                        {Object.entries(roomData.players || {}).sort((a,b) => b[1].score - a[1].score).map(([uid, p]) => (
                                            <div key={uid} className="flex justify-between items-center px-4">
                                                <span className={`text-xs font-bold ${uid === user.uid ? 'text-cyan-400' : 'text-gray-400'}`}>{p.name} {uid === user.uid && '(××ª)'}</span>
                                                <div className="flex-1 mx-4 h-1.5 bg-black/40 rounded-full overflow-hidden">
                                                    <div className={`h-full transition-all duration-500 ${uid === user.uid ? 'bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.8)]' : 'bg-gray-600'}`} style={{ width: `${Math.min(100, (p.score/1000)*100)}%` }}></div>
                                                </div>
                                                <span className="text-xs font-black tabular-nums">{p.score}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {screen === 'results' && (
                            <div className="text-center space-y-10 animate-in zoom-in">
                                <div className="text-8xl mb-4">ğŸ†</div>
                                <div className="glass p-12 rounded-[3.5rem] shadow-3xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 to-fuchsia-500"></div>
                                    <div className="text-[10px] font-black tracking-widest text-gray-500 uppercase mb-4 italic">Session Complete</div>
                                    <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Final Score</div>
                                    <div className="text-9xl font-black mb-10 italic tabular-nums">{score}</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-white/5 p-6 rounded-2xl border border-white/5">
                                            <div className="text-fuchsia-400 text-3xl font-black tabular-nums">{streak}</div>
                                            <div className="text-[10px] text-gray-500 uppercase font-bold mt-1">×©×™× ×¨×¦×£</div>
                                        </div>
                                        <div className="bg-white/5 p-6 rounded-2xl border border-white/5">
                                            <div className="text-cyan-400 text-3xl font-black tabular-nums">{Math.floor(score/10)}</div>
                                            <div className="text-[10px] text-gray-500 uppercase font-bold mt-1">× ×›×•× ×•×ª</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => setScreen('welcome')} className="flex-1 py-5 glass rounded-2xl font-black uppercase tracking-widest">Exit</button>
                                    <button onClick={() => startGame()} className="flex-1 py-5 bg-cyan-600 rounded-2xl font-black uppercase shadow-xl shadow-cyan-900/40 tracking-widest">Restart</button>
                                </div>
                            </div>
                        )}

                        {screen === 'multi-choice' && (
                            <div className="w-full space-y-8 animate-in slide-in-from-bottom-6">
                                <div className="glass p-10 rounded-[3rem] space-y-8 border-fuchsia-500/20 shadow-2xl">
                                    <h3 className="text-2xl font-black italic uppercase tracking-tighter">Multiplayer <span className="text-fuchsia-400">Battle</span></h3>
                                    <div className="flex gap-3">
                                        <input type="text" placeholder="ROOM CODE" className="flex-1 bg-black/50 border-2 border-white/5 rounded-2xl px-5 py-4 uppercase text-center font-black tracking-widest text-xl focus:border-fuchsia-500 outline-none shadow-inner" value={roomId} onChange={e => setRoomId(e.target.value)} />
                                        <button onClick={joinRoom} className="bg-fuchsia-600 px-8 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Join</button>
                                    </div>
                                    <div className="relative flex items-center justify-center"><div className="w-full border-t border-white/10 absolute"></div><span className="relative bg-[#020617] px-4 text-[10px] font-black text-gray-500 uppercase italic">Or create</span></div>
                                    <button onClick={createRoom} className="w-full bg-cyan-600 py-6 rounded-[1.5rem] font-black text-xl shadow-xl uppercase tracking-tighter italic">Host Session</button>
                                </div>
                                <button onClick={() => setScreen('welcome')} className="w-full text-gray-500 font-bold hover:text-white transition uppercase text-[10px] tracking-widest">Abort Mission</button>
                            </div>
                        )}

                        {screen === 'lobby' && roomData && (
                            <div className="w-full space-y-8 animate-in zoom-in">
                                <div className="glass p-10 rounded-[3rem] text-center border-cyan-500/40 shadow-3xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-cyan-400 animate-pulse"></div>
                                    <span className="text-gray-500 text-[10px] uppercase font-black tracking-widest">Active Frequency Code</span>
                                    <h2 className="text-7xl font-black mt-4 tracking-widest neon-text tabular-nums italic">{roomId}</h2>
                                    <div className="mt-8 flex justify-center gap-6 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                        <span>TIME: {roomData.time}s</span>
                                        <span>â€¢</span>
                                        <span>RANK: {DIFFICULTIES[difficulty].label}</span>
                                    </div>
                                </div>
                                <div className="glass rounded-[3rem] overflow-hidden shadow-xl border-white/5">
                                    <div className="bg-white/5 p-4 font-black text-[10px] uppercase flex justify-between px-10 tracking-[0.3em] border-b border-white/5">
                                        <span>Connected Pilots</span>
                                        <span className="text-cyan-400">{Object.keys(roomData.players||{}).length}</span>
                                    </div>
                                    <div className="p-4 space-y-2">
                                        {Object.values(roomData.players||{}).map((p, i) => (
                                            <div key={i} className="flex items-center gap-5 p-4 bg-white/5 rounded-2xl border border-white/5 transition-all">
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-600 to-fuchsia-600 flex items-center justify-center font-black">{p.name[0]}</div>
                                                <span className="flex-1 font-black text-lg">{p.name} {p.name === playerName && '(××ª)'}</span>
                                                <span className="text-green-500 text-[9px] font-black uppercase animate-pulse">Ready</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {roomData.host === user?.uid ? (
                                    <button onClick={() => fb.api.updateDoc(fb.api.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'rooms', roomId), { status: 'playing' })} className="w-full py-6 bg-gradient-to-r from-fuchsia-600 via-pink-600 to-purple-700 rounded-3xl font-black text-2xl shadow-2xl hover:scale-105 transition-all uppercase tracking-tighter italic">Initiate Combat</button>
                                ) : <div className="text-center p-12 glass rounded-[3.5rem] animate-pulse font-black text-fuchsia-400 uppercase italic tracking-tighter">Commander launching mission soon...</div>}
                            </div>
                        )}

                        {screen === 'teacher-dashboard' && (
                            <div className="w-full space-y-8 animate-in fade-in">
                                <div className="flex justify-between items-center glass p-10 rounded-[3rem]">
                                    <div className="flex items-center gap-4">
                                        <div className="w-10 h-10 bg-fuchsia-500 rounded-lg shadow-lg shadow-fuchsia-900/40"></div>
                                        <h2 className="text-2xl font-black italic uppercase tracking-tight">Records</h2>
                                    </div>
                                    <button onClick={() => setScreen('welcome')} className="bg-white/10 px-4 py-1 rounded-lg text-xs font-bold hover:bg-white/20 transition uppercase tracking-widest">Close</button>
                                </div>
                                <div className="glass rounded-[3rem] overflow-hidden shadow-2xl border-white/5">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-right text-sm">
                                            <thead className="bg-white/5 text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5">
                                                <tr><th className="p-6">Name</th><th className="p-6">Score</th><th className="p-6">Rank</th><th className="p-6 text-left">Date</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5 font-bold">
                                                {history.length ? history.map(h => (
                                                    <tr key={h.id} className="hover:bg-cyan-500/5 transition">
                                                        <td className="p-6">{h.name}</td>
                                                        <td className="p-6 text-cyan-400 font-black text-2xl tabular-nums tracking-tighter">{h.score}</td>
                                                        <td className="p-6 text-gray-500 text-xs">{h.difficulty}</td>
                                                        <td className="p-6 text-[10px] text-gray-600 text-left tabular-nums">{new Date(h.timestamp).toLocaleDateString('he-IL')}</td>
                                                    </tr>
                                                )) : <tr><td colSpan="4" className="p-24 text-center text-gray-600 italic uppercase tracking-widest text-xs">No records found</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {screen === 'solo-config' && (
                            <div className="w-full space-y-8 animate-in fade-in">
                                <h2 className="text-3xl font-black text-center uppercase tracking-tighter italic underline decoration-cyan-500/30 underline-offset-8">Manual <span className="text-cyan-400">Override</span></h2>
                                <div className="grid grid-cols-4 gap-3">
                                    {TABLES_LIST.map(num => (
                                        <button key={num} onClick={() => setSelectedTables(p => p.includes(num) ? p.filter(n => n !== num) : [...p, num])} className={`py-6 rounded-3xl font-black text-3xl transition-all border-2 active:scale-90 shadow-lg ${selectedTables.includes(num) ? 'bg-cyan-600 border-cyan-300 text-white shadow-cyan-900/40' : 'bg-white/5 border-white/10 text-gray-700 hover:border-white/30'}`}>{num}</button>
                                    ))}
                                </div>
                                <button onClick={() => startGame()} disabled={selectedTables.length === 0} className="w-full py-6 bg-gradient-to-r from-cyan-600 to-blue-700 rounded-3xl font-black text-xl shadow-xl disabled:opacity-20 uppercase tracking-widest">Start Mission</button>
                            </div>
                        )}
                        
                    </main>

                    <footer className="mt-auto py-10 text-center text-gray-600 text-[9px] font-black border-t border-white/5 w-full shrink-0 tracking-[0.5em] uppercase bg-black/20">
                        ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×—×Ÿ ××‘×™×¦×•×¨ Â© 2026
                    </footer>

                    {feedback && (
                        <div className="fixed inset-0 flex items-center justify-center z-[200] pointer-events-none p-6">
                            <div className={`text-6xl font-black italic px-16 py-8 rounded-[3rem] shadow-3xl border-4 uppercase animate-in zoom-in duration-150 text-center ${feedback.type==='correct'?'bg-green-600 border-green-300 text-white shadow-[0_0_50px_rgba(34,197,94,0.4)]':'bg-red-600 border-red-300 text-white shadow-[0_0_50px_rgba(239,68,68,0.4)]'}`}>
                                {feedback.val}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>